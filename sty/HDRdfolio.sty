% !TeX root = ../hdr_dfolio.tex
% !TeX encoding = UTF-8
% !TeX program = lualatex
\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{HDRdfolio}[2018/01/29 \space v2\space Dfolio's HDR package style]


\RequirePackage{ifthen,ifpdf,xspace,calc}
\RequirePackage{ifluatex} % LuaTeX is required. Not XeTeX, dvips, or pdfTeX.
\RequirePackage{luatex85} % Needed for compatibility when using LuaTeX 0.95 etc.

\RequirePackage{pdftexcmds} % compatibility
\ifluatex
  % New with TeXlive 2016. Removes unnecessary File Data:
  \pdfvariable suppressoptionalinfo 511 % writes only ID to PDF Catalog
\else
  \PackageError{HDRdfolio}{Must compile with LuaLaTeX 0.95+}{Sorry, LuaLaTeX only.%
  No pdfTeX, dvips, or XeTeX.}
\fi
%\RequirePackage{etoolbox} % general good stuff

%\RequirePackage{ucs}
%\RequirePackage{t1enc}
%\RequirePackage[T1]{fontenc}
%\RequirePackage[utf8x]{inputenc}

\@ifpackageloaded{babel}{\@DF@Info{babel header still loaded}
  \PassOptionsToPackage{french,main=english}{babel}
}{\RequirePackage[french,main=english]{babel}}
%\RequirePackage[french,main=english]{babel}
\selectlanguage{english}
%\selectlanguage{francais} 
%\frenchspacing
%\frenchbsetup{ThinSpaceInFrenchNumbers,FrenchFootnotes,AutoSpacePunctuation} % \ThinSpaceInFrenchNumbers
%\AutoSpaceBeforeFDP

%\def\findrootlanguage{%
%   \def\rootlanguagename{english}%
%}


\RequirePackage{graphicx}
\RequirePackage[a4paper,centering,offset=0pt,]{geometry}

\RequirePackage{keyval}
\RequirePackage{xkeyval}
%%     ------------------------------------------------------------

\newif\if@DF@verbose\@DF@verbosetrue
\newif\if@DF@warning\@DF@warningtrue
\newif\if@draft\@draftfalse
\let\@df@finaltrue\@draftfalse
\let\@df@finalfalse\@drafttrue

\DeclareOptionX{verbose}[false]{\csname @DF@verbose#1\endcsname}
\DeclareOptionX{draft}[true]{\csname @draft#1\endcsname}
\DeclareOptionX{final}[true]{\csname @finaltrue#1\endcsname}
\ExecuteOptionsX{final=true}
\ProcessOptionsX
%%      Warning and info ------------------------------------------------------------

\providecommand\ifVerbose[2][\relax]{\if@DF@verbose{#2}\else{#1}\fi}
\providecommand\ifWarning[2][\relax]{\if@DF@warning{#2}\else{#1}\fi}
\def\@DF@Warning#1{\ifWarning{\PackageWarning{HDRdfolio}{#1}}}
\def\@DF@WarningNoLine#1{\ifWarning{\PackageWarningNoLine{HDRdfolio}{#1}}}
\def\@DF@Info#1{\ifVerbose{%
    \typeout{***********************************************************************}
    \PackageInfo{HDRdfolio}{#1}\typeout{#1}
    \typeout{***********************************************************************}
}}
\def\IfDraft#1{\if@draft#1\fi}
\def\IfFinal#1{\if@draft\relax\else{#1}\fi}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\IfDraft{
  \geometry{showframe}
  \setlength\overfullrule{1pt}
  \@DF@Warning{\jobname compiled using draft mode. Not for final release!}
}
\IfFinal{
  \setlength\overfullrule{\z@}
}
% taille des liserets
%\renewcommand{\headrulewidth}{0.5pt}
%\renewcommand{\footrulewidth}{0.5pt}

\def\@draft@overlay#1{\tikz[remember picture,overlay]{\node[rotate=60,scale=10,text opacity=0.2] at (current page.center) {#1};}}

\newcommand{\reviewtimetoday}[2]{\special{!userdict begin
    /bop-hook{gsave 20 710 translate 45 rotate 0.8 setgray
      /Times-Roman findfont 12 scalefont setfont 0 0   moveto (#1) show
      0 -12 moveto (#2) show grestore}def end}}


\relpenalty=10000       % empeche la c\'esure des \'equations
\binoppenalty=10000

\@ifpackageloaded{textcomp}{\@DF@Info{textcomp package still loaded}}{\RequirePackage{textcomp}}
\@ifpackageloaded{mathcomp}{\@DF@Info{mathcomp package still loaded}}{\RequirePackage{mathcomp}}
\@ifpackageloaded{amsmath}{\@DF@Info{amsmath package still loaded}}{\RequirePackage{amsmath}}
\@ifpackageloaded{amsthm}{\@DF@Info{amsmath package still loaded}}{\RequirePackage{amsthm}}
\@ifpackageloaded{amsfonts}{\@DF@Info{amsfonts package still loaded}}{\RequirePackage{amsfonts}}
\@ifpackageloaded{amssymb}{\@DF@Info{amssymb package still loaded}}{\RequirePackage{amssymb}}
\@ifpackageloaded{bm}{\@DF@Info{bm package still loaded}}{\RequirePackage{bm}}

\RequirePackage{multicol}\columnseprule=0.5pt
\RequirePackage{multirow}
\RequirePackage{enumerate,array,tabularx}
\RequirePackage{vmargin}          %Definition des marges
\RequirePackage{ulem}             % for uline to underline text

\RequirePackage{caption}
\RequirePackage{subfloat}
\RequirePackage{framed}
\RequirePackage[input-decimal-markers=.,exponent-product=\cdot,tight-spacing = true,per-mode = symbol]{siunitx}%,per-symbol=\text{~div~}
\RequirePackage{fancyhdr,fancybox}
\usepackage{pdfpages}   

% % FONTs, COLOR AND styles
\@ifpackageloaded{marvosym}{\@DF@Info{marvosym package still loaded}}{\RequirePackage{marvosym}}
\@ifpackageloaded{xcolor}{\@DF@Info{xcolor header still loaded}
  \PassOptionsToPackage{svgnames,dvipsnames,table}{xcolor}}{\RequirePackage[svgnames,dvipsnames,table]{xcolor}}
\RequirePackage{relsize}
%\RequirePackage{lmodern}
%\RequirePackage[scaled=.92]{helvet}
\RequirePackage{aecompl,wasysym,pifont} %lmodern
\RequirePackage{lettrine}
\renewcommand{\LettrineTextFont}{\sffamily\scshape}
\renewcommand{\LettrineFontHook}{\sffamily}%\fontshape{sl}
\RequirePackage{ragged2e}
\RequirePackage{fontspec}
\setsansfont{Calibri}

\RequirePackage{fncychap}



%\RequirePackage{pgf}
\RequirePackage{tikz}
% Annotation et commentaires
\RequirePackage[author={DF}]{pdfcomment}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\input{HDRdfolio_styles.sty}
% ---------------------------------------------------------------------------------
%  Listes de commandes modifiant le style des chapitres, tables des mati\`ere etc...
% ---------------------------------------------------------------------------------

\setcounter{secnumdepth}{4}            % niveau de hi\'erarchisation titres
%\setcounter{minitocdepth}{2}           % niveau de hi\'erarchisation des minitocs
\setcounter{tocdepth}{3}               % niveau de hi\'erarchisation de la table des mati\`eres


\let\@afterindentfalse\@afterindenttrue
\parindent=1.5em
\parskip=0pt plus 1pt
\abovedisplayskip=12pt plus 3pt minus 9pt
\abovedisplayshortskip=0pt plus 3pt
\belowdisplayskip=12pt plus 3pt minus 9pt
\belowdisplayshortskip=7pt plus 3pt minus 4pt
\topskip=10pt
\splittopskip=10pt
\parfillskip=0pt plus 1fil


% Ajoute si n\'ecessaire une page blanche pour que la page suivante soit impaire (\`a droite)
\newcommand{\clearemptydoublepage}{\markboth{}{}\fancyhf{}%
  \ifthenelse{\isodd{\value{page}}}{\newpage{\thispagestyle{empty}}}{}\cleardoublepage\pagestyle{fancy}}

%\ChNameUpperCase
%\ChNameVar{\fontsize{14}{16}\usefont{OT1}{phv}{m}{n}\selectfont\raggedleft}
%\ChNumVar{\fontsize{60}{62}\usefont{OT1}{ptm}{m}{n}\selectfont\raggedleft}
%\ChTitleVar{\Huge\usefont{OT1}{phv}{m}{n}\selectfont\raggedleft}


%{Label #1 is associated to the value  \ref{#1} // \autoref{#1} and the page \pageref{#1}}
\renewcommand\thechapter{\@Roman\c@chapter}
%
% 
\newcommand\specialchapter@cx[2][\@empty]{%
  \chapter[#2]{{#2}}\ifthenelse{\equal{#1}{}}{\label{chap:\thechapter}}{\label{chap:#1}}
}
%
\newcommand{\Chapitre}[2][]{%
  \clearemptydoublepage%
  %\chapter[#1]{{#1}}%
  \thispagestyle{plain}%
  \global\@topnum\z@
  \renewcommand\@chapapp{\chaptername}
  \specialchapter@cx[#1]{#2}
  \renewcommand\@chapapp{Chap.}
  %\vfill  \newpage%
  \fancyhf{}
  \fancyhead[LE]{{\headfootfont\leftmark}}%
  \fancyhead[RO]{{\headfootfont\rightmark}}%
  \fancyfoot[R]{\headfootfont\thepage}%
  \fancyfoot[L]{{\headfootfont\foot@banner}}
}

\def\foot@banner{
  \if@draft\@draft@overlay{Draft}
  {\relsize{-2}{\slshape Draft of {\normalfont{\texttt{\jobname}}}}, %
    {build on \today{} }
    \hfill}
  \else\@author
  \fi}

% %From Glenn chapter style
\renewcommand{\DOCH}{%
  \settoheight{\myhi}{\CTV\FmTi{Test}}
  \setlength{\py}{\baselineskip}
  \addtolength{\py}{\RW}
  \addtolength{\py}{\myhi}
  \setlength{\pyy}{\py}
  \addtolength{\pyy}{-1\RW}
  \raggedright
  \CNV\FmN{\@chapapp}\space\CNoV\thechapter
  \hskip 3pt\color{chapterrule}\mghrulefill{\RW}\rule[-1\pyy]{2\RW}{\py}\par\nobreak%  \vskip 20\p@
}

\renewcommand{\DOTI}[1]{%
  \addtolength{\pyy}{-4pt}
  \settoheight{\myhi}{\CTV\FmTi{#1}}
  \addtolength{\myhi}{\py}
  \addtolength{\myhi}{-1\RW}
  \vskip -1\pyy
  {\color{chapterrule}\rule{2\RW}{\myhi}\mghrulefill{\RW}}\hskip 2pt
  \raggedleft\CTV\FmTi{#1}\par\nobreak
  \vskip 2em plus1em minus 1ex}
%\renewcommand{\DOTIS}[1]{%
%  \raggedright
%  \CTV\FmTi{#1}\par\nobreak
%  \vskip 20\p@}
%\def\@makechapterhead#1{ %\leftmark{#1}%
%  \vspace*{20\p@}%
%  {\parindent \z@ \raggedright \normalfont
%    \ifnum \c@secnumdepth >\m@ne
%    \if@mainmatter%%%%% Fix for frontmatter, mainmatter, and backmatter 040920
%    \DOCH
%    \fi
%    \fi
%    \interlinepenalty\@M
%    \if@mainmatter%%%%% Fix for frontmatter, mainmatter, and backmatter 060424
%    \DOTI{#1}%
%    \else%
%    \DOTIS{#1}%
%    \fi
%}}

%\providecommand\theHchapter    {\arabic{chapter}}%
\newcommand{\Appendix}{
  \clearemptydoublepage
  \gdef\theHchapter{\Hy@AlphNoErr{chapter}}
  \appendix
}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% GESTION DES SECTIONS ----
% \@startsection {NAME}{LEVEL}{INDENT}{BEFORESKIP}{AFTERSKIP}{STYLE}
%            optional * [ALTHEADING]{HEADING}
%    Generic command to start a section.
%    NAME       : e.g., 'subsection'.p
%    LEVEL      : a number, denoting depth of section -- e.g., chapter=1,
%                 section = 2, etc.  A section number will be printed if
%                 and only if LEVEL < or = the value of the secnumdepth
%                 counter.
%    INDENT     : Indentation of heading from left margin
%    BEFORESKIP : Absolute value = skip to leave above the heading.
%                 If negative, then paragraph indent of text following
%                 heading is suppressed.
%    AFTERSKIP  : if positive, then skip to leave below heading,
%                       else - skip to leave to right of run-in heading.
%    STYLE      : commands to set style
%  If '*' missing, then increments the counter.  If it is present, then
%  there should be no [ALTHEADING] argument.  A sectioning command
%  is normally defined to \@startsection + its first six arguments.
\renewcommand\section{\@startsection {section}{1}{-1em}%
  {-4ex \@plus -2ex \@minus -.5ex}%
  {2.3ex \@plus.2ex}%
  {\sectionfont\color{section}}}
\renewcommand\subsection{\@startsection{subsection}{2}{\z@}%
  {-3.25ex\@plus -1ex \@minus -.2ex}%
  {1.5ex \@plus .2ex}%
  {\subsectionfont\color{subsection}}}
\renewcommand\subsubsection{\@startsection{subsubsection}{3}{\z@}%
  {-1.25ex\@plus -0.5ex \@minus -.2ex}%
  {.5ex \@plus .1ex}%
  {\subsubsectionfont\color{subsubsection}}}
\renewcommand\paragraph{\@startsection{paragraph}{4}{1em}%
  {-1.125ex\@plus -0.25ex \@minus -.1ex}%
  {0.25ex}%
  {\paragraphfont\color{paragraphparagraph}}}
\renewcommand\subparagraph{\@startsection{subparagraph}{5}{\parindent}%
  {3.25ex \@plus1ex \@minus .2ex}%
  {-1em}%
  {\subparagraphfont}}
\renewcommand\theparagraph{\Alph{paragraph})}
\renewcommand\thesubparagraph{\roman{subparagraph})}


\newcommand{\Introduction}[1][Introduction]{\section*{#1}\sectionmark{#1}\thispagestyle{plain}}


% ---------------------------------------------------------------------------------
\renewcommand\tableofcontents{
  \global\@topnum\z@
  \phantomsection
  \chapter*{\chapterfont\contentsname\@mkboth{\contentsname}{\contentsname}}%
  \addcontentsline{toc}{chapter}{\contentsname}
  \fancyhead[LE]{{\headfootfont\leftmark}}%
  \fancyhead[RO]{{\headfootfont\rightmark}}%
  \fancyfoot[C]{\headfootfont\thepage}%
  \fancyfoot[L]{{\headfootfont\foot@banner}}
  \@starttoc{toc}%
}



\renewcommand\listoffigures{
  \global\@topnum\z@
  \phantomsection
  \chapter*{\listfigurename\@mkboth{\listfigurename}{\listfigurename}}%
  \addcontentsline{toc}{chapter}{\listfigurename}
  \fancyhead[LE]{{\headfootfont\leftmark}}%
  \fancyhead[RO]{{\headfootfont\rightmark}}%
  \fancyfoot[C]{\headfootfont\thepage}%
  \fancyfoot[L]{{\headfootfont\foot@banner}}
  \@starttoc{lof}%
}
\renewcommand\listoftables{
\global\@topnum\z@
\phantomsection
\chapter*{\listtablename\@mkboth{\listtablename}{\listtablename}}%
\addcontentsline{toc}{chapter}{\listtablename}
\fancyhead[LE]{{\headfootfont\leftmark}}%
\fancyhead[RO]{{\headfootfont\rightmark}}%
\fancyfoot[C]{\headfootfont\thepage}%
\fancyfoot[L]{{\headfootfont\foot@banner}}
\@starttoc{lot}%
}


\let\book@l@chapter\l@chapter
\renewcommand*\l@chapter[2]{
  \book@l@chapter{\lchapterfont#1}{\lchapterfont#2}}

\renewcommand\@dotsep{2.5}
\renewcommand*\l@section[2]{\@dottedtocline{1}{1em}{1.5em}{\lsectionfont#1}{\lsectionfont#2}}
\renewcommand*\l@subsection[2]{\@dottedtocline{2}{2.5em}{2em}{\lsubsectionfont#1}{\lsubsectionfont#2}}
\renewcommand*\l@subsubsection[2]{\@dottedtocline{3}{3.5em}{2em}{\lsubsubsectionfont#1}{\subsubsectionfont#2}}
\renewcommand*\l@paragraph[2]{\@dottedtocline{4}{10em}{5em}{\lparagraphfont#1}{\lparagraphfont#2}}
\renewcommand*\l@subparagraph[2]{\@dottedtocline{5}{12em}{6em}{\lsubparagraphfont#1}{\lsubparagraphfont#2}}

\renewcommand*\l@figure[2]{\@dottedtocline{1}{1em}{1.5em}{\lsubsectionfont#1}{\lsubsectionfont#2}}
\renewcommand*\l@table[2]{\@dottedtocline{1}{1em}{1.5em}{\lsubsectionfont#1}{\lsubsectionfont#2}}
% ---------------------------------------------------------------------------------
% % Biblio
\RequirePackage{url}
%\RequirePackage{multibib}
%\newcites{journal,conference}{{Journals},{Conferences}}
%\newcites{df}{David Folio Reference}
%\RequirePackage[backend=bibtex]{biblatex}
\RequirePackage[sort&compress,square, nonamebreak,comma,numbers]{natbib}

%\bibliographystyle{IEEEtran}
\providecommand{\doi}[1]{{\smaller doi:\href{http://dx.doi.org/\detokenize{#1}}{\detokenize{#1}}}\xspace}
\providecommand{\natexlab}[1]{#1}
\setlength{\bibhang}{\z@}
\setlength{\bibindent}{\z@}
\newenvironment{Mybibliography}[1]
{
  \bibstyle{plainnat}
  \bibpreamble
  \bibfont
  %\def\bibnumfmt{#2}
  %\renewcommand{\bibnumfmt}[1]{[#2\,##1]}
  %\renewcommand\@biblabel[1]{[#2\,##1]}
  \list{\@biblabel{DF\@arabic{NAT@ctr}}}%
  { %\smaller
    \@openbib@code
   \@bibsetup{#1}%   
   \usecounter{NAT@ctr}}% %% only changed here to usecounter
   \renewcommand\newblock{\hskip .11em \@plus.33em \@minus.07em}%
    \sloppy\clubpenalty4000\widowpenalty4000
    \sfcode`\.=1000\relax
    \let\citeN\cite \let\shortcite\cite
    \let\citeasnoun\cite
}
{\def\@noitemerr
  {\@latex@warning{Empty `thebibliography' environment}}%
  \endlist}
\newcommand{\CICL}[1]{[CICL\,\citenum{#1}]\xspace}
\renewenvironment{thebibliography}[1]
{\phantomsection
  \chapter*{\bibname}%
  \addcontentsline{toc}{chapter}{\bibname}
  %\@mkboth{\headfootfont\bibname}{\headfootfont\bibname}%
  %\let\bibnumfmt\@empty
  \list{\@biblabel{\@arabic{NAT@ctr}}}%
  {\bibpreamble
    \bibfont
    \@openbib@code
    \@bibsetup{#1}%
    \usecounter{NAT@ctr}}% %% only changed here to usecounter
  \sloppy\clubpenalty4000
  \@clubpenalty\clubpenalty
  \widowpenalty4000%
  \sfcode`\.\@m}
{\def\@noitemerr
  {\@latex@warning{Empty `thebibliography' environment}}%
  \endlist}

% ---------------------------------------------------------------------------------
\@ifpackageloaded{hyperref}{\@DF@Info{hyperref package still loaded}
  %\PassOptionsToPackage{pdfpagelabels,pdfencoding=auto}{hyperref} 
}{\RequirePackage[pdfa]{hyperref}}  
\@ifpackageloaded{translator}{\@DF@Info{translator package still loaded}
  %\PassOptionsToPackage{pdfpagelabels,pdfencoding=auto}{hyperref} 
}{\RequirePackage[french,english]{translator}}  
% Glossary / list of abbreviations
\RequirePackage[nomain,acronym,section,nonumberlist,toc,xindy]{glossaries} %nomain, if you define glossaries in a file, and you use \include{These_glossary}
%\RequirePackage[xindy]{imakeidx}


\RequirePackage{longtable}
%% \Nomenclature
\setglossarystyle{longheaderborder}
\setlength{\glsdescwidth}{.75\linewidth-1em}

%Generate a list of symboles
\providecommand{\symbolslistname}{List of symbols}
\newglossary[slg]{symbolslist}{syi}{syg}{\symbolslistname}
\renewcommand*{\glspostdescription}{}

\providecommand{\glossaryname}{Glossary}
\newglossary{glg}{gls}{glo}{\glossaryname}


\providecommand{\indexlistname}{{Index of terms and notations}}
\newcommand{\Glossaries}[1][\@empty]{%
  \clearemptydoublepage
  \global\@topnum\z@  
  \phantomsection
  \chapter*{\chapterfont\indexlistname\@mkboth{\indexlistname}{\indexlistname}}%
  \addcontentsline{toc}{chapter}{\indexlistname}
  \fancyhead[LE]{{\headfootfont\leftmark}}%
  \fancyhead[RO]{{\headfootfont\rightmark}}%
  \fancyfoot[C]{\headfootfont\thepage}%
  \fancyfoot[L]{{\headfootfont\foot@banner}} %
  %TODO: Nomeclature
  %\printnoidxglossary[type=nomenclature,style=nomenclature]
  %Acronym
  \printnoidxglossary[type=\acronymtype,style=list]
  %Print the glossary
  \printnoidxglossary[type=glg,style=altlist,title=Glossary]
}

%\newglossarystyle{nomenclature}{%
%  \renewcommand*{\glossaryheader}{%
%    \hline
%    \bfseries Notation&\bfseries\descriptionname&
%    \bfseries Unit\'e\\\hline\endhead
%    \hline\endfoot}%
%  \setlength{\glsdescwidth}{.7\linewidth-1em}
%  \setlength{\glspagelistwidth}{4.5em}
%  % allow line wrap in the description column
%  \renewenvironment{theglossary}%
%  {\begin{longtable}{|l|p{\glsdescwidth}|p{\glspagelistwidth}|}}%
%    {\end{longtable}}%,xindy
%  \renewcommand{\glsgroupskip}{}% make nothing happen between groups
%  % swap second and third columns
%  \renewcommand*{\glossaryentryfield}[5]{%
%    \glsentryitem{##1}\glstarget{##1}{##2} & ##3 & ##4\\[0.5ex]\hline}
%  % sub-entries
%  \renewcommand*{\glossarysubentryfield}[6]{%
%    \glssubentryitem{##2}%
%    \glstarget{##2}{##3} &  ##4 & ##6\\}%
%  
%}
%
%\newcommand{\Nomenclature}[1][\@empty]{%
%  \clearemptydoublepage%
%  \chapter*{Glossaires}
%  \fancyhead[LE]{{\headfootfont\glossaryname}}%
%  \fancyhead[RO]{{\headfootfont\glossaryname}}%
%  \cfoot{\headfootfont\thepage}
%  \ifx#1\@empty\relax\else\input{#1} \fi
%  %Print list of symbols
%  \printglossary[type=nomenclature,style=nomenclature]
%  \pagebreak[3]
%  %Acronyme
%  \printglossary[type=\acronymtype,style=list]
%}



% ---------------------------------------------------------------------------------
% % Lists
\RequirePackage{enumitem}
\setlist{noitemsep}
%\setlist[1]{\labelindent=\parindent} % < Usually a good idea
\setlist[itemize]{leftmargin=*}
\setlist[itemize,1]{label={\bfseries\textbullet}}
\setlist[itemize,2]{label={\bfseries\textendash}}
% \renewcommand{\labelitemi}{{\bfseries\textbullet}}
% \renewcommand{\labelitemii}{{\bfseries\textendash}}
% \renewcommand{\labelitemiii}{\textasteriskcentered}

\newcommand*{\listitemsymbol}      {\labelitemi~}
% lengths
\newlength{\quotewidth}
\newlength{\hintscolumnwidth}
\setlength{\hintscolumnwidth}{5.em}
\newlength{\separatorcolumnwidth}
\setlength{\separatorcolumnwidth}{0.025\textwidth}
\newlength{\maincolumnwidth}
\newlength{\doubleitemmaincolumnwidth}
\newlength{\listitemsymbolwidth}
\settowidth{\listitemsymbolwidth}{\listitemsymbol}
\newlength{\listitemmaincolumnwidth}
\newlength{\listdoubleitemmaincolumnwidth}
\newlength{\baseletterheight}

% ---------------------------------------------------------------------------------

\let\sep\pdfx@sep
\global\let\@author\@empty
\global\let\@date\@empty
\global\let\@title\@empty
\global\let\@subject\@empty
\global\let\@keywords\@empty
\global\let\@copyright\@empty

\gdef\title#1{\gdef\@title{#1}\gdef\pdfx@Title{#1}}
\gdef\thetitle{\@title}
\gdef\subject#1{\gdef\@subject{#1}\gdef\pdfx@Subject{#1}}
\gdef\thesubject{\@subject}
\gdef\keywords#1{\gdef\@keywords{#1}\gdef\pdfx@Keywords{#1}}
\gdef\thekeywords{\@keywords}
\gdef\author#1{\gdef\@author{#1}\gdef\pdfx@Author{#1}}
\gdef\theauthor{\@author}
\gdef\copyright#1{\gdef\@copyright{#1}}
\gdef\thecopyright{\@copyright}
% ---------------------------------------------------------------------------------
%% \AtEndPreamble sets defaults and calculates layout
%% -----------------------------------------------------------------------------
%%
\AtEndPreamble{
  \makeatletter % Necessary. Why? Who knows.
  \@DF@Info{AtEndPreamble : BEGIN}
  
  \ifx\@copyright\@empty\global\def\@copyright{Copyright \@backslashchar copyright \the\year "\@author"}\fi
\begingroup
  \xdef\hdr@xmpdata{
    \@backslashchar Title{\@title}^^J
    \@backslashchar Subject{\@subject}^^J
    \@backslashchar Keywords{\@keywords}^^J
    \@backslashchar Author{\@author}^^J
    \@backslashchar CoverDate{\@date}^^J
    \@backslashchar Copyright{\@copyright}^^J
  }
\newwrite\file
\immediate\openout\file=\jobname.xmpdata
\immediate\write\file{\hdr@xmpdata^^J}
\closeout\file
\endgroup

\hypersetup{
  pdfencoding=unicode,unicode,
  psdextra,
  hypertexnames=false,
  pdflang=en-EN,
  pdfpagelabels=true,
  breaklinks=true,
  bookmarks=false,
} %hyperindex=true,pagebackref=false

\@DF@Info{AtEndPreamble : END}
  \raggedbottom  % is not the default for twoside
  \makeatother
}
%%

%% \AtBeginDocument finishes the setup
%% -----------------------------------------------------------------------------
%
\AtBeginDocument{
  \@DF@Info{AtBeginDocument : BEGIN}  
  \@ifpackageloaded{bookmark}{\@DF@Info{bookmark package still loaded}}{\RequirePackage{bookmark}}
  %\usepackage{xmpincl}
  %\includexmp{pdfa-1b}
  %\recomputelengths % from geometry
  %\let\copyright\relax
      
  
  \@DF@Info{def bibname}
  \renewcommand\bibname{References}
  \@DF@Info{AtBeginDocument : END}
}
\endinput
%%
%% End of file 
